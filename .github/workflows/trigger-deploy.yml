name: Trigger Deploy Pipeline

on:
  push:
    branches: ["main"]

jobs:
  trigger:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 커밋 메시지에서 [manual], [notest] 뽑아서 env에 기록
    - name: Parse commit flags
      run: |
        COMMIT_MSG="${{ github.event.head_commit.message }}"

        if [[ "$COMMIT_MSG" == *"[notest]"* ]]; then
          echo "SKIP_TESTS=true" >> $GITHUB_ENV
        else
          echo "SKIP_TESTS=false" >> $GITHUB_ENV
        fi

        if [[ "$COMMIT_MSG" == *"[manual]"* ]]; then
          echo "MANUAL_SWITCH=true" >> $GITHUB_ENV
        else
          echo "MANUAL_SWITCH=false" >> $GITHUB_ENV
        fi

    # 테스트 (SKIP_TESTS == false 일 때만)
    - name: Run tests
      if: env.SKIP_TESTS == 'false'
      run: |
        ./gradlew --no-daemon clean test

    # ⬇ 새로 추가: 항상 리포트 업로드
    - name: Upload test report
      if: always() # 테스트 실패해도 이 스텝은 실행
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: |
          build/reports/tests/test
          build/test-results/test
        if-no-files-found: ignore

    # private repo로 repository_dispatch 날리기
    - name: Trigger private deploy workflow
      if: env.SKIP_TESTS == 'true' || success() # 테스트 스킵이거나, 테스트 성공한 경우만 배포 트리거
      env:
        TOKEN: ${{ secrets.ACTIONS_RELAY_TOKEN }}
        MANUAL_SWITCH: ${{ env.MANUAL_SWITCH }}
        SKIP_TESTS: ${{ env.SKIP_TESTS }}
      run: |
        PAYLOAD=$(cat <<EOF
        {
          "event_type": "deploy_request",
          "client_payload": {
            "manual_switch": ${MANUAL_SWITCH},
            "skip_tests": ${SKIP_TESTS}
          }
        }
        EOF
        )

        curl -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${TOKEN}" \
          https://api.github.com/repos/PhysicksKim/footballay-core-action/dispatches \
          -d "${PAYLOAD}"
