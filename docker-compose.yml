# ========================================
# Docker Compose for Footballay Core
# ========================================
# Purpose: Local development and testing with Docker
#
# This compose file is for LOCAL TESTING ONLY.
# It demonstrates how the application runs in a container with external config mounting.
#
# Usage:
#   docker compose up --build           # Build and start
#   docker compose down                 # Stop and remove
#   docker compose logs -f              # View logs
#
# Health Check:
#   curl http://localhost:8080/actuator/health
#   Expected: {"status":"UP"}
#
# Network Setup:
#   - This compose uses the existing PostgreSQL and Redis containers running on host
#   - Host network mode allows the container to connect to host's localhost:5432 and localhost:6379
#
# Production Deployment:
#   In production (EC2), containers are run directly with `docker run` (not compose)
#   See: docs/archi/script/deploy.sh
# ========================================

services:
  footballay-core:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: footballay-core-dev

    # Use host network mode to access host's PostgreSQL and Redis
    # This allows the container to connect to localhost:5432 (postgres) and localhost:6379 (redis)
    # Note: network_mode: host is Linux-specific. On Mac, use "host.docker.internal" in config instead
    # network_mode: host  # Uncomment on Linux

    environment:
      # Port configuration
      SERVER_PORT: "8080"

      # Profile: base (cookies config) + dev (devbase + devpostgre + devaws) + mockapi (mock API data)
      # This matches the dev environment setup from CLAUDE.md
      # base: includes application-cookies.yml
      # dev: profile group = devbase, devpostgre, devaws
      # mockapi: uses mock JSON data instead of real API calls
      SPRING_PROFILE: "base,dev,mockapi"

      # Memory limit for local testing (simulating t3.small EC2 constraints)
      # On EC2, this will be set to "-Xmx512m" to prevent OOM
      JAVA_TOOL_OPTIONS: "-Xmx1024m"

    ports:
      # Map container port 8080 to host port 8080
      # For blue/green testing, we'll use different host ports (8081, 8082)
      - "8080:8080"

    volumes:
      # Mount local-config directory to /config-external in container
      # This simulates how we'll mount /srv/footballay/config-live on EC2
      # The application reads these files via --spring.config.additional-location
      - ./local-config:/config-external:ro

    # Extra hosts for Mac Docker Desktop
    # This ensures host.docker.internal resolves correctly to host machine
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Restart policy
    # "unless-stopped" means the container will restart automatically unless explicitly stopped
    restart: unless-stopped

    # Health check (defined in Dockerfile, but can be overridden here)
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
    #   interval: 30s
    #   timeout: 10s
    #   start_period: 60s
    #   retries: 3

    # Dependencies (if we add postgres/redis to this compose in the future)
    # depends_on:
    #   - postgres
    #   - redis

# Optional: Add postgres and redis services here if you want a fully containerized dev environment
# For now, we're using the existing host containers (footballay-dev-postgres, footballay-dev-redis)

# networks:
#   footballay-network:
#     driver: bridge
